name: Deploy to Azure Container App

on:
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME }}
  IMAGE_NAME: qolors/feedcord:latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # Required for requesting the JWT
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        # We process the JSON secret to extract individual values for OIDC login
        client-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        tenant-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
        subscription-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Deploy to Azure Container Apps
      run: |
        # Use Python to safely process the secret (immune to shell mangling)
        # We write it to a temporary file to avoid shell quoting hell
        python3 -c "import os, json; print(json.dumps(json.loads(os.environ['FEEDCORD_APPSETTINGS'])))" > appsettings.min.json

        # Update the secret using the @file syntax
        az containerapp secret set \
          --name "${CONTAINER_APP_NAME}" \
          --resource-group "${AZURE_RESOURCE_GROUP}" \
          --secrets "appsettings-json=@appsettings.min.json"

        # THEN trigger update with new image. 
        # We add a dummy env var with a timestamp to FORCE a new revision.
        az containerapp update \
          --name "${CONTAINER_APP_NAME}" \
          --resource-group "${AZURE_RESOURCE_GROUP}" \
          --container-name feedcord \
          --image "${IMAGE_NAME}" \
          --set-env-vars "DEPLOY_TIMESTAMP=$(date +%s)"
      env:
        FEEDCORD_APPSETTINGS: ${{ secrets.FEEDCORD_APPSETTINGS }}
