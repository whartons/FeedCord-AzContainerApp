name: Deploy to Azure Container App

on:
  workflow_dispatch:

env:
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME }}
  IMAGE_NAME: qolors/feedcord:latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # Required for requesting the JWT
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        # We process the JSON secret to extract individual values for OIDC login
        client-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        tenant-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
        subscription-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Deploy to Azure Container Apps
      shell: python
      run: |
        import os
        import subprocess
        import json

        # Fetch environment variables
        container_app_name = os.environ['CONTAINER_APP_NAME']
        resource_group = os.environ['AZURE_RESOURCE_GROUP']
        image_name = os.environ['IMAGE_NAME']
        raw_settings = os.environ['FEEDCORD_APPSETTINGS']

        # Minify JSON to ensure it fits comfortably in the secret value
        minified_settings = json.dumps(json.loads(raw_settings))

        # DEBUG: Verify what is actually being sent to Azure
        # We print first 100 chars to avoid leaking full secrets in logs
        print(f"DEBUG: JSON to upload (first 100 chars): {minified_settings[:100]}...")

        # Explicit safety check for the error we keep seeing in logs
        if '[""]' in minified_settings:
            print("!!! FATAL ERROR !!!: The JSON still contains an invalid empty string [\"\"].")
            print("Please fix your GitHub Secret 'FEEDCORD_APPSETTINGS' and provide valid empty arrays [].")
            exit(1)

        print(f"Updating secrets for {container_app_name}...")
        subprocess.run([
            "az", "containerapp", "secret", "set",
            "--name", container_app_name,
            "--resource-group", resource_group,
            "--secrets", f"appsettings-json={minified_settings}"
        ], check=True)

        print(f"Updating container and forcing new revision...")
        subprocess.run([
            "az", "containerapp", "update",
            "--name", container_app_name,
            "--resource-group", resource_group,
            "--container-name", "feedcord",
            "--image", image_name,
            "--set-env-vars", f"DEPLOY_TIMESTAMP={subprocess.check_output(['date', '+%s']).decode().strip()}"
        ], check=True)
      env:
        FEEDCORD_APPSETTINGS: ${{ secrets.FEEDCORD_APPSETTINGS }}
