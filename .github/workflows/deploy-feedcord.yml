name: Deploy to Azure Container App

on:
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: ${{ vars.ACR_NAME }}.azurecr.io
  # Map repository variables into env so steps can use simple shell vars
  ACR_NAME: ${{ vars.ACR_NAME }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME }}
  IMAGE_NAME: feedcord

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # Required for requesting the JWT
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        # We process the JSON secret to extract individual values for OIDC login
        client-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        tenant-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
        subscription-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Azure CLI - Login to ACR
      run: |
        az acr login --name $ACR_NAME

    - name: Build and push container image with curl
      run: |
        docker build -t ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest - <<EOF
        FROM qolors/feedcord:latest
        RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*
        EOF
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp registry set \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --server $AZURE_CONTAINER_REGISTRY \
          --identity system

        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --image $AZURE_CONTAINER_REGISTRY/$IMAGE_NAME:latest \
          --set-secrets "appsettings-json=${{ secrets.FEEDCORD_APPSETTINGS }}"
