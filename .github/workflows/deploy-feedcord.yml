name: Deploy to Azure Container App

on:
  workflow_dispatch:

env:
  AZURE_CONTAINER_REGISTRY: ${{ vars.ACR_NAME }}.azurecr.io
  # Map repository variables into env so steps can use simple shell vars
  ACR_NAME: ${{ vars.ACR_NAME }}
  AZURE_RESOURCE_GROUP: ${{ vars.AZURE_RESOURCE_GROUP }}
  CONTAINER_APP_NAME: ${{ vars.CONTAINER_APP_NAME }}
  IMAGE_NAME: feedcord

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write # Required for requesting the JWT
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        # We process the JSON secret to extract individual values for OIDC login
        client-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        tenant-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).tenantId }}
        subscription-id: ${{ fromJson(secrets.AZURE_CREDENTIALS).subscriptionId }}

    - name: Azure CLI - Login to ACR
      run: |
        az acr login --name $ACR_NAME

    - name: Pull upstream Docker image
      run: |
        docker pull qolors/feedcord:latest

    - name: Client tag image
      run: |
        docker tag qolors/feedcord:latest ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Push Docker image to ACR
      run: |
        docker push ${{ env.AZURE_CONTAINER_REGISTRY }}/${{ env.IMAGE_NAME }}:latest

    - name: Deploy to Azure Container Apps
      run: |
        az containerapp registry set \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --server $AZURE_CONTAINER_REGISTRY \
          --identity system

        # Use Python to safely process the secret (immune to shell mangling)
        MINIFIED_SETTINGS=$(python3 -c "import os, json; print(json.dumps(json.loads(os.environ['FEEDCORD_APPSETTINGS'])))")

        # Update the secret FIRST
        az containerapp secret set \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --secrets "appsettings-json=$MINIFIED_SETTINGS"

        # THEN trigger update with new image. 
        # We add a dummy env var with a timestamp to FORCE a new revision so it picks up the new secret.
        az containerapp update \
          --name $CONTAINER_APP_NAME \
          --resource-group $AZURE_RESOURCE_GROUP \
          --container-name feedcord \
          --image $AZURE_CONTAINER_REGISTRY/$IMAGE_NAME:latest \
          --set-env-vars "DEPLOY_TIMESTAMP=$(date +%s)"
      env:
        FEEDCORD_APPSETTINGS: ${{ secrets.FEEDCORD_APPSETTINGS }}
